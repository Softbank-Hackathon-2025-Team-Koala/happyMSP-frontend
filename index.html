<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Î∞∞Ìè¨ Î™®ÎãàÌÑ∞ÎßÅ</title>
    <style>
        /* Í∏∞Ï°¥ Ïä§ÌÉÄÏùºÍ≥º ÎèôÏùºÌïòÎØÄÎ°ú ÏÉùÎûµ (Î≥ÄÍ≤Ω ÏóÜÏùå) */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }
        h1 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
            font-size: 28px;
        }

        .stage-indicator {
            display: none;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 20px;
        }
        .stage-indicator.show { display: block; }
        .stage-indicator h2 { font-size: 18px; margin-bottom: 5px; }
        .stage-indicator .stage-description { font-size: 14px; opacity: 0.9; }

        .input-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; color: #555; font-weight: 500; }
        input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        input:focus { outline: none; border-color: #667eea; }

        button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        button:active { transform: translateY(0); }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .disconnect-btn {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            margin-top: 10px;
        }
        .disconnect-btn:hover {
            box-shadow: 0 10px 20px rgba(220, 53, 69, 0.3);
        }

        .status {
            margin-top: 20px;
            padding: 16px;
            border-radius: 10px;
            font-size: 14px;
            line-height: 1.6;
        }
        .status.connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .service-cards-container {
            display: none;
            margin: 40px 0;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 15px;
        }
        .service-cards-container.show { display: block; }

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 30px;
            justify-items: center;
        }

        .service-card {
            background: linear-gradient(135deg, #0db7ed 0%, #0a8fc9 100%);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(13, 183, 237, 0.4);
            color: white;
            position: relative;
            overflow: hidden;
            width: 100%;
            max-width: 320px;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .service-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(13, 183, 237, 0.5);
        }

        .service-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
        }

        .service-card.failed {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            box-shadow: 0 10px 30px rgba(220, 53, 69, 0.4);
        }

        .service-card.success {
            background: linear-gradient(135deg, #28a745 0%, #218838 100%);
            box-shadow: 0 10px 30px rgba(40, 167, 69, 0.4);
        }

        .service-header {
            text-align: center;
            margin-bottom: 25px;
            position: relative;
            z-index: 1;
        }

        .docker-icon {
            font-size: 80px;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
            margin-bottom: 15px;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .service-name {
            font-size: 22px;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            word-break: break-word;
        }

        .deployment-steps {
            display: flex;
            flex-direction: column;
            gap: 15px;
            position: relative;
            z-index: 1;
        }

        .step {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.3s;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .step.pending {
            border-color: rgba(255, 255, 255, 0.5);
            background: rgba(255, 255, 255, 0.25);
        }

        .step.success {
            background: rgba(255, 255, 255, 0.35);
            border-color: rgba(255, 255, 255, 0.8);
        }

        .step.failed {
            background: rgba(0, 0, 0, 0.2);
            border-color: rgba(255, 255, 255, 0.4);
        }

        .step-icon {
            font-size: 28px;
            min-width: 28px;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
        }

        .step-info { flex: 1; }

        .step-name {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 5px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        .step-status {
            font-size: 13px;
            opacity: 0.95;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        .step-spinner {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 8px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .log-container {
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 16px;
            display: none;
        }
        .log-container.show { display: block; }

        .log-entry {
            padding: 10px;
            margin-bottom: 10px;
            background: white;
            border-radius: 6px;
            font-size: 13px;
            border-left: 3px solid #667eea;
            line-height: 1.5;
        }

        .log-entry.stage-start { border-left-color: #667eea; background: #e8eef9; font-weight: 600; }
        .log-entry.stage-success { border-left-color: #28a745; background: #d4edda; }
        .log-entry.stage-failed { border-left-color: #dc3545; background: #f8d7da; }
        .log-entry.service-list { border-left-color: #17a2b8; background: #d1ecf1; white-space: pre-line; }
        .log-entry.deployment-info { border-left-color: #ffc107; background: #fff3cd; }
        .log-entry.info { border-left-color: #17a2b8; background: #d1ecf1; }
        .log-entry.connected { border-left-color: #28a745; background: #d4edda; }

        .timestamp { color: #999; font-size: 11px; margin-right: 8px; }

        .loading {
            display: inline-block; width: 14px; height: 14px;
            border: 2px solid #667eea; border-top-color: transparent;
            border-radius: 50%; animation: spin 1s linear infinite;
            margin-right: 8px; vertical-align: middle;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Î∞∞Ìè¨ Î™®ÎãàÌÑ∞ÎßÅ</h1>

        <div id="stageIndicator" class="stage-indicator">
            <h2 id="stageName">ÎåÄÍ∏∞ Ï§ë...</h2>
            <div class="stage-description" id="stageDescription"></div>
        </div>

        <div class="input-group">
            <label for="repoUrl">GitHub Repository URL</label>
            <input type="text" id="repoUrl" placeholder="https://github.com/username/repo" value="https://github.com/example/test-repo">
        </div>

        <button id="connectBtn" onclick="handleStartButton()">Î∞∞Ìè¨ Î™®ÎãàÌÑ∞ÎßÅ ÏãúÏûë</button>
        <button id="disconnectBtn" class="disconnect-btn" onclick="disconnectSSE()" style="display: none;">Ïó∞Í≤∞ Ï¢ÖÎ£å</button>

        <div id="status"></div>
        <div id="serviceCardsContainer" class="service-cards-container"><div class="cards-grid" id="cardsGrid"></div></div>
        <div id="logContainer" class="log-container"></div>
    </div>

    <script>
        let eventSource = null;
        let currentStage = 0;
        let serviceCardsMap = {};
        let discoveredServices = new Set();
        let deploymentFailed = false;

        async function sendRepositoryRequest(repoUrl) {
            try {
                addLog(`Î∂ÑÏÑù ÏöîÏ≤≠ Ï†ÑÏÜ° Ï§ë... (${repoUrl})`, 'info');
                const response = await fetch('/api/repository', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ repositoryUrl: repoUrl })
                });
                if (!response.ok) {
                    const errorText = await response.text();
                    addLog(`‚ùå Î∂ÑÏÑù ÏöîÏ≤≠ Ïã§Ìå®: ${response.status} - ${errorText}`, 'stage-failed');
                    showStatus('Repository ÏöîÏ≤≠ Ïã§Ìå®', 'error');
                }
            } catch (error) {
                console.error('Fetch Error:', error);
                addLog(`‚ùå ÌÜµÏã† Ïò§Î•ò: ${error.message}`, 'stage-failed');
            }
        }

        async function handleStartButton() {
            const repoUrl = document.getElementById('repoUrl').value.trim();
            if (!repoUrl) {
                showStatus('Repository URLÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.', 'error');
                return;
            }

            try {
                const encodedUrl = encodeURIComponent(repoUrl);
                // Î≥ÄÍ≤ΩÎêú Î∂ÄÎ∂Ñ: /api/repository?url=... Ìò∏Ï∂úÌïòÏó¨ ÏÉÅÌÉú Í∞ùÏ≤¥ ÌôïÏù∏
                const response = await fetch(`/api/repository?url=${encodedUrl}`);

                if (response.ok) {
                    const data = await response.json();
                    // GetRepositoryResponseDtoÏùò state ÌïÑÎìú ÌôïÏù∏
                    // Enum: NO_EXIST, DEPLOYING, DEPLOYED
                    if (data.state === 'DEPLOYING') {
                        window.location.href = `/dashboard.html?repo=${encodedUrl}`;
                        return;
                    }
                    // DEPLOYING ÏÉÅÌÉúÏù¥Í±∞ÎÇò NO_EXIST ÏÉÅÌÉúÏù¥Î©¥ Î∞∞Ìè¨/Î™®ÎãàÌÑ∞ÎßÅ ÏßÑÌñâ
                }
            } catch (e) {
                console.error("Î∞∞Ìè¨ ÏÉÅÌÉú ÌôïÏù∏ Ïã§Ìå®, Í∏∞Ï°¥ ÌùêÎ¶ÑÏúºÎ°ú ÏßÑÌñâÌï©ÎãàÎã§.", e);
            }
            // ÏÉÅÌÉúÍ∞Ä DEPLOYEDÍ∞Ä ÏïÑÎãàÍ±∞ÎÇò ÌôïÏù∏Ïóê Ïã§Ìå®ÌïòÎ©¥ Í∏∞Ï°¥ÎåÄÎ°ú SSE Ïó∞Í≤∞ ÏãúÏûë
            connectSSE();
        }

        function connectSSE() {
            const repoUrl = document.getElementById('repoUrl').value.trim();

            if (!repoUrl) {
                showStatus('Repository URLÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.', 'error');
                return;
            }

            if (eventSource) eventSource.close();

            deploymentFailed = false;
            serviceCardsMap = {};
            discoveredServices.clear();

            document.getElementById('connectBtn').disabled = true;
            document.getElementById('disconnectBtn').style.display = 'block';
            document.getElementById('stageIndicator').classList.add('show');
            updateStage(0, 'Ïó∞Í≤∞ Ï§ë...', '');
            document.getElementById('logContainer').classList.add('show');
            clearLogs();

            const encodedUrl = encodeURIComponent(repoUrl);
            const sseUrl = `/api/metrics/deployments?repo_url=${encodedUrl}`;

            addLog('Î∞∞Ìè¨ Î™®ÎãàÌÑ∞ÎßÅ SSE Ïó∞Í≤∞ ÏãúÎèÑ Ï§ë...', 'info');
            eventSource = new EventSource(sseUrl);

            sendRepositoryRequest(repoUrl);

            eventSource.addEventListener('connected', (e) => {
                showStatus('‚úÖ Ïó∞Í≤∞ ÏÑ±Í≥µ', 'connected');
                addLog('‚úÖ SSE Ïä§Ìä∏Î¶º Ïó∞Í≤∞Îê®: ' + e.data, 'connected');
            });

            eventSource.addEventListener('stage-1-start', (e) => {
                updateStage(1, '1Îã®Í≥Ñ: MSA ÏÑúÎπÑÏä§ ÌÉêÏÉâ', 'RepositoryÏóê Ïó∞Í≤∞Îêú ÏÑúÎπÑÏä§Î•º Ï∞æÍ≥† ÏûàÏäµÎãàÎã§...');
                addLog(e.data, 'stage-start');
            });

            eventSource.addEventListener('stage-1-success', (e) => {
                addLog(e.data, 'stage-success');
                const match = e.data.match(/(\d+)Í∞ú ÏÑúÎπÑÏä§/);
                if (match) {
                    const serviceCount = parseInt(match[1]);
                    initializeServiceCards(serviceCount);
                }
            });

            eventSource.addEventListener('stage-1-failed', (e) => {
                updateStage(1, '1Îã®Í≥Ñ: Ïã§Ìå®', '');
                addLog(e.data, 'stage-failed');
                handleDeploymentFailure('1Îã®Í≥ÑÏóêÏÑú Ïã§Ìå®');
            });

            // stage-2-start Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
            eventSource.addEventListener('stage-2-start', (e) => {
                updateStage(2, '2Îã®Í≥Ñ: EKS Î∞∞Ìè¨', 'Kubernetes ÌÅ¥Îü¨Ïä§ÌÑ∞Ïóê Î∞∞Ìè¨ Ï§ë...');

                try {
                    // 1. SSE Îç∞Ïù¥ÌÑ∞ ÌååÏã± (JSON Í∞ùÏ≤¥ ÏàòÏã†)
                    const data = JSON.parse(e.data);
                    const message = data.message; // ÌôîÎ©¥ Î°úÍ∑∏Ïö© Î©îÏãúÏßÄ
                    const deploymentPayload = data.payload; // /api/deploy Ï†ÑÏÜ°Ïö© ÌéòÏù¥Î°úÎìú

                    addLog(message, 'stage-start');

                    // 2. Î∞±ÏóîÎìúÎ°ú Î∞∞Ìè¨ ÏöîÏ≤≠ (ÎèôÏ†Å Îç∞Ïù¥ÌÑ∞ ÏÇ¨Ïö©)
                    fetch('/api/api/deploy', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(deploymentPayload) // DBÏóêÏÑú Ï°∞ÌöåÌïú Ïã§Ï†ú Îç∞Ïù¥ÌÑ∞ Ï†ÑÏÜ°
                    }).catch(error => {
                        console.error('Internal Deployment Trigger Failed:', error);
                    });

                } catch (err) {
                    console.error("Failed to parse stage-2-start payload", err);
                    // ÌïòÏúÑ Ìò∏ÌôòÏÑ± (ÎßåÏïΩ Îã®ÏàúÌûà Î¨∏ÏûêÏó¥Îßå Ïò® Í≤ΩÏö∞)
                    addLog(e.data, 'stage-start');
                }
            });

            eventSource.addEventListener('service-list', (e) => addLog(e.data, 'service-list'));
            eventSource.addEventListener('deployment-info', (e) => addLog(e.data, 'deployment-info'));
            eventSource.addEventListener('deployment-log', (e) => addLog('üìã ' + e.data, 'info'));

            eventSource.addEventListener('service-update', (e) => {
                try {
                    const data = JSON.parse(e.data);
                    const { serviceName, step, status, message } = data;

                    if (!serviceCardsMap[serviceName]) createServiceCard(serviceName);
                    updateServiceStep(serviceName, step, status, message);

                    if (status === 'FAILED') handleServiceFailure(serviceName, step, message);
                } catch (error) {
                    console.error('service-update ÌååÏã± Ïò§Î•ò:', error);
                }
            });

            eventSource.addEventListener('all-complete', (e) => {
                updateStage(99, '‚úÖ Î∞∞Ìè¨ ÏôÑÎ£å', 'Î™®Îì† Îã®Í≥ÑÍ∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§');
                showStatus('üéâ Î∞∞Ìè¨ ÏÑ±Í≥µ: ' + e.data, 'connected');
                addLog('‚úÖ Î∞∞Ìè¨ ÏÑ±Í≥µ: ' + e.data, 'stage-success');
                Object.keys(serviceCardsMap).forEach(serviceName => {
                    serviceCardsMap[serviceName].classList.add('success');
                });
                setTimeout(() => disconnectSSE(), 3000);
            });

            eventSource.addEventListener('deployment-failed', (e) => {
                updateStage(99, '‚ùå Î∞∞Ìè¨ Ïã§Ìå®', '');
                showStatus('‚ùå Î∞∞Ìè¨ Ïã§Ìå®: ' + e.data, 'error');
                addLog('‚ùå Î∞∞Ìè¨ Ïã§Ìå®: ' + e.data, 'stage-failed');
                handleDeploymentFailure(e.data);
            });

            eventSource.onerror = (error) => console.error('SSE Error:', error);
        }

        function disconnectSSE() {
            if (eventSource) { eventSource.close(); eventSource = null; }
            document.getElementById('connectBtn').disabled = false;
            document.getElementById('disconnectBtn').style.display = 'none';
            document.getElementById('stageIndicator').classList.remove('show');
            if (!deploymentFailed) showStatus('Ïó∞Í≤∞Ïù¥ Ï¢ÖÎ£åÎêòÏóàÏäµÎãàÎã§.', 'info');
        }

        function updateStage(stage, name, description) {
            currentStage = stage;
            document.getElementById('stageName').innerHTML = name;
            document.getElementById('stageDescription').textContent = description;
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = 'status ' + type;
        }

        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry ' + type;
            const timestamp = new Date().toLocaleTimeString('ko-KR');
            logEntry.innerHTML = `<span class="timestamp">[${timestamp}]</span>${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function clearLogs() { document.getElementById('logContainer').innerHTML = ''; }

        function initializeServiceCards(count) {
            const container = document.getElementById('serviceCardsContainer');
            container.classList.add('show');
            const grid = document.getElementById('cardsGrid');
            grid.innerHTML = '';
            serviceCardsMap = {};
            discoveredServices.clear();
        }

        function createServiceCard(serviceName) {
            if (discoveredServices.has(serviceName)) return;
            discoveredServices.add(serviceName);
            const grid = document.getElementById('cardsGrid');
            const card = document.createElement('div');
            card.className = 'service-card';
            card.dataset.service = serviceName;
            card.innerHTML = `
                <div class="service-header">
                    <div class="docker-icon">üê≥</div>
                    <div class="service-name">${serviceName}</div>
                </div>
                <div class="deployment-steps">
                    <div class="step" data-step="RESOURCE">
                        <div class="step-icon">üì¶</div>
                        <div class="step-info"><div class="step-name">K8s Î¶¨ÏÜåÏä§ ÏÉùÏÑ±</div><div class="step-status">ÎåÄÍ∏∞ Ï§ë...</div></div>
                    </div>
                    <div class="step" data-step="POD">
                        <div class="step-icon">üöÄ</div>
                        <div class="step-info"><div class="step-name">Pod Íµ¨Îèô</div><div class="step-status">ÎåÄÍ∏∞ Ï§ë...</div></div>
                    </div>
                    <div class="step" data-step="INGRESS">
                        <div class="step-icon">üåê</div>
                        <div class="step-info"><div class="step-name">Ïô∏Î∂Ä Ï†ëÏÜç ÏÑ§Ï†ï</div><div class="step-status">ÎåÄÍ∏∞ Ï§ë...</div></div>
                    </div>
                </div>`;
            grid.appendChild(card);
            serviceCardsMap[serviceName] = card;
            addLog(`üê≥ ÏÑúÎπÑÏä§ Ï∂îÏ†Å ÏãúÏûë: ${serviceName}`, 'info');
        }

        function updateServiceStep(serviceName, step, status, message) {
            const card = serviceCardsMap[serviceName];
            if (!card) return;
            const stepElement = card.querySelector(`[data-step="${step}"]`);
            if (!stepElement) return;
            const statusElement = stepElement.querySelector('.step-status');
            stepElement.classList.remove('pending', 'success', 'failed');
            if (status === 'PENDING') {
                stepElement.classList.add('pending');
                statusElement.innerHTML = message + ' <span class="step-spinner"></span>';
            } else if (status === 'SUCCESS') {
                stepElement.classList.add('success');
                statusElement.textContent = '‚úÖ ' + message;
            } else if (status === 'FAILED') {
                stepElement.classList.add('failed');
                statusElement.textContent = '‚ùå ' + message;
            }
        }

        function handleServiceFailure(serviceName, step, message) {
            const card = serviceCardsMap[serviceName];
            if (card) card.classList.add('failed');
            const errorMsg = `ÏÑúÎπÑÏä§ [${serviceName}]Ïùò ${step} Îã®Í≥ÑÏóêÏÑú Ïã§Ìå®: ${message}`;
            handleDeploymentFailure(errorMsg);
        }

        function handleDeploymentFailure(reason) {
            if (deploymentFailed) return;
            deploymentFailed = true;
            updateStage(99, '‚ùå Î∞∞Ìè¨ Ïã§Ìå®', 'Î∞∞Ìè¨Í∞Ä Ï§ëÎã®ÎêòÏóàÏäµÎãàÎã§');
            showStatus('‚ùå Î∞∞Ìè¨ Ïã§Ìå®: ' + reason, 'error');
            addLog('‚ùå Î∞∞Ìè¨ Ïã§Ìå®Î°ú Ïù∏Ìïú Ïó∞Í≤∞ Ï¢ÖÎ£å: ' + reason, 'stage-failed');
            setTimeout(() => {
                if (eventSource) { eventSource.close(); eventSource = null; }
                document.getElementById('connectBtn').disabled = false;
                document.getElementById('disconnectBtn').style.display = 'none';
            }, 1000);
        }

        window.addEventListener('beforeunload', () => { if (eventSource) eventSource.close(); });
    </script>
</body>
</html>